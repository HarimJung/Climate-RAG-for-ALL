'use client';

import { useRef, useEffect } from 'react';
import * as d3 from 'd3';

interface CountryPoint {
  iso3: string;
  country: string;
  vulnerability: number;
  readiness: number;
  risk_level: string;
  color: string;
}

const POINTS: CountryPoint[] = [
  { iso3: 'BGD', country: 'Bangladesh', vulnerability: 0.5684, readiness: 0.2793, risk_level: 'high', color: '#fb923c' },
  { iso3: 'NGA', country: 'Nigeria', vulnerability: 0.4811, readiness: 0.2526, risk_level: 'high', color: '#c084fc' },
  { iso3: 'BRA', country: 'Brazil', vulnerability: 0.3685, readiness: 0.3505, risk_level: 'medium', color: '#34d399' },
  { iso3: 'KOR', country: 'South Korea', vulnerability: 0.3567, readiness: 0.7223, risk_level: 'medium', color: '#60a5fa' },
  { iso3: 'USA', country: 'United States', vulnerability: 0.312, readiness: 0.6473, risk_level: 'medium', color: '#f87171' },
  { iso3: 'DEU', country: 'Germany', vulnerability: 0.3015, readiness: 0.6816, risk_level: 'medium', color: '#fbbf24' },
];

export function VulnerabilityChart() {
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (!containerRef.current) return;
    const container = containerRef.current;

    function draw() {
      container.innerHTML = '';

      const margin = { top: 20, right: 20, bottom: 50, left: 60 };
      const width = container.clientWidth;
      const height = 380;
      const innerW = width - margin.left - margin.right;
      const innerH = height - margin.top - margin.bottom;

      const svg = d3.select(container)
        .append('svg')
        .attr('width', width)
        .attr('height', height);

      const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

      const x = d3.scaleLinear().domain([0.2, 0.8]).range([0, innerW]);
      const y = d3.scaleLinear().domain([0.25, 0.62]).range([0, innerH]);

      // Grid
      g.append('g')
        .call(d3.axisLeft(y).tickSize(-innerW).tickFormat(() => ''))
        .call(sel => sel.selectAll('line').attr('stroke', '#1e293b').attr('stroke-dasharray', '2,2'))
        .call(sel => sel.select('.domain').remove());

      g.append('g')
        .call(d3.axisBottom(x).tickSize(-innerH).tickFormat(() => ''))
        .attr('transform', `translate(0,${innerH})`)
        .call(sel => sel.selectAll('line').attr('stroke', '#1e293b').attr('stroke-dasharray', '2,2'))
        .call(sel => sel.select('.domain').remove());

      // Axes
      g.append('g')
        .attr('transform', `translate(0,${innerH})`)
        .call(d3.axisBottom(x).ticks(6))
        .call(sel => sel.select('.domain').attr('stroke', '#334155'))
        .call(sel => sel.selectAll('text').attr('fill', '#64748b').attr('font-size', '12'));

      g.append('g')
        .call(d3.axisLeft(y).ticks(6))
        .call(sel => sel.select('.domain').attr('stroke', '#334155'))
        .call(sel => sel.selectAll('text').attr('fill', '#64748b').attr('font-size', '12'));

      // Axis labels
      svg.append('text')
        .attr('x', margin.left + innerW / 2).attr('y', height - 6)
        .attr('text-anchor', 'middle').attr('fill', '#64748b').attr('font-size', '12')
        .text('Readiness (higher = more prepared)');

      svg.append('text')
        .attr('transform', `rotate(-90)`)
        .attr('x', -(margin.top + innerH / 2)).attr('y', 14)
        .attr('text-anchor', 'middle').attr('fill', '#64748b').attr('font-size', '12')
        .text('Vulnerability (higher = more vulnerable)');

      // Quadrant labels
      g.append('text').attr('x', 8).attr('y', 16)
        .attr('fill', '#334155').attr('font-size', '10').text('High Vuln / Low Ready');
      g.append('text').attr('x', innerW - 8).attr('y', innerH - 8)
        .attr('text-anchor', 'end').attr('fill', '#334155').attr('font-size', '10').text('Low Vuln / High Ready');

      // Points
      POINTS.forEach((p) => {
        const cx = x(p.readiness);
        const cy = y(p.vulnerability);

        g.append('circle')
          .attr('cx', cx).attr('cy', cy).attr('r', 8)
          .attr('fill', p.color).attr('fill-opacity', 0.8)
          .attr('stroke', p.color).attr('stroke-width', 2).attr('stroke-opacity', 0.3);

        g.append('text')
          .attr('x', cx + 12).attr('y', cy + 4)
          .attr('fill', p.color).attr('font-size', '11').attr('font-weight', '600')
          .text(p.iso3);
      });
    }

    draw();
    const observer = new ResizeObserver(() => draw());
    observer.observe(container);
    return () => observer.disconnect();
  }, []);

  return <div ref={containerRef} className="w-full" />;
}
